syntax = "proto3";

package vaelix.control;

// Control Protocol - Defines IPC for browser engine and orchestration
// This protocol handles tab lifecycle, navigation, and browser control

message TabInfo {
    int32 tab_id = 1;
    string url = 2;
    string title = 3;
    bool is_loading = 4;
    bool can_go_back = 5;
    bool can_go_forward = 6;
    bytes favicon_data = 7;
    string content_type = 8;
}

message StartTabRequest {
    string url = 1;
    int32 tab_id = 2;
    map<string, string> headers = 3;
    bool private_mode = 4;
    string user_agent = 5;
}

message StartTabResponse {
    bool success = 1;
    string error_message = 2;
    bytes initial_favicon = 3;
}

message StopTabRequest {
    int32 tab_id = 1;
    bool force_close = 2;
}

message StopTabResponse {
    bool success = 1;
    string error_message = 2;
}

message NavigateRequest {
    int32 tab_id = 1;
    string url = 2;
    bool force_reload = 3;
}

message NavigateResponse {
    bool success = 1;
    string error_message = 2;
    string redirected_url = 3;
}

message GetTabInfoRequest {
    int32 tab_id = 1;
}

message GetTabInfoResponse {
    TabInfo tab_info = 1;
    bool success = 2;
    string error_message = 3;
}

message TabClosedEvent {
    int32 tab_id = 1;
    int32 close_reason = 2; // 0=normal, 1=force, 2=crash
}

message TabUpdatedEvent {
    int32 tab_id = 1;
    TabInfo tab_info = 2;
    string update_type = 3; // "url", "title", "favicon", "loading"
}

message BrowserShutdownRequest {
    bool force_kill = 1;
    string reason = 2;
}

message BrowserShutdownResponse {
    bool success = 1;
    repeated int32 remaining_tabs = 2;
    int32 shutdown_delay_ms = 3;
}

// Browser Statistics and Monitoring
message BrowserMetrics {
    int32 active_tabs = 1;
    int64 memory_usage_mb = 2;
    double cpu_usage_percent = 3;
    int64 network_bytes_received = 4;
    int64 network_bytes_sent = 5;
    double render_time_ms = 6;
}

message GetBrowserMetricsRequest {
    bool include_detailed_stats = 1;
}

message GetBrowserMetricsResponse {
    BrowserMetrics metrics = 1;
    bool success = 2;
    string timestamp = 3;
}

// gRPC Service Definition
service BrowserControlService {
    // Tab lifecycle management
    rpc StartTab(StartTabRequest) returns (StartTabResponse);
    rpc StopTab(StopTabRequest) returns (StopTabResponse);
    rpc Navigate(NavigateRequest) returns (NavigateResponse);
    rpc GetTabInfo(GetTabInfoRequest) returns (GetTabInfoResponse);

    // Browser control
    rpc Shutdown(BrowserShutdownRequest) returns (BrowserShutdownResponse);
    rpc GetMetrics(GetBrowserMetricsRequest) returns (GetBrowserMetricsResponse);

    // Event streams (bidirectional for real-time updates)
    rpc TabEvents(stream TabEvent) returns (stream TabEvent);
}

message TabEvent {
    oneof event {
        TabClosedEvent closed = 1;
        TabUpdatedEvent updated = 2;
        string browser_event = 3;
        string error_event = 4;
        double performance_metric = 5;
    }
}
